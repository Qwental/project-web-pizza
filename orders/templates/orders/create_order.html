{% extends 'base.html' %}
{% load static %}
{% block css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
{% endblock %}




{% block content %}
    <section>
        <div class="alert alert-warning text-center" role="alert">
            Пожалуйста, заполните адрес электронной почты.
        </div>
        <div class="container">
            <div class="py-5 text-center">
                <h1>Оформление заказа</h1>
            </div>

            <div class="row g-5">

                {#  Корзина#}
                <div class="col-md-5 col-lg-4 order-md-last">
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-primary">Корзина</span>
                        <span class="badge badge-primary badge-pill text-white">{{ cartContent.total_quantity }}</span>
                    </h4>
                    <ul class="list-group mb-3">

                        {% for cartItem in cartContent %}
                            <li class="list-group-item d-flex justify-content-between lh-sm">
                                <div>
                                    <h6 class="my-0">{{ cartItem.product.name }}</h6>
                                    <small class="text-muted">{{ cartItem.quantity }} шт.</small>
                                </div>
                                <span class="text-muted">{{ cartItem.final_price }} руб.</span>
                            </li>
                        {% endfor %}

                        <li class="list-group-item d-flex justify-content-between">
                            <span>Сумма к оплате</span>
                            <strong>{{ cartContent.total_price }}₽</strong>
                        </li>
                    </ul>
                </div>
                {# КОНЕЦ Корзины#}

                <div class="col-md-7 col-lg-8">


                    <!-- ФОРМА-->
                    <form action="{% url 'orders:create_order' %}" method="post">
                        {% csrf_token %}


                        <div class="row g-3">
                            {# first_name #}
                            <div class="col-md-6 mb-3">
                                <label for="id_first_name" class="form-label">Имя*:</label>
                                <input type="text" class="form-control" id="id_first_name"
                                       value="{% if form.first_name.value %}{{ form.first_name.value }}{% endif %}"
                                       name="first_name" required>
                                {% if form.first_name.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show">{{ form.first_name.errors }}</div>
                                {% endif %}
                            </div>

                            {# last_name #}
                            <div class="col-md-6 mb-3">
                                <label for="id_last_name" class="form-label">Фамилия*:</label>
                                <input type="text" class="form-control" id="id_last_name" name="last_name"
                                       value="{% if form.last_name.value %}{{ form.last_name.value }}{% endif %}"
                                       required>
                                {% if form.last_name.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show">{{ form.last_name.errors }}</div>
                                {% endif %}
                            </div>

                            {# email #}
                            {#                            <div class="col-sm-6">#}
                            {#                                <label for="id_email" class="form-label">Адрес электронной почты*</label>#}
                            {#                                <input type="email" class="form-control" id="email" placeholder="you@example.com"#}
                            {#                                       required>#}
                            {#                                <input type="email" class="form-control" id="id_email" name="last_name"#}
                            {#                                       placeholder="you@example.com"#}
                            {#                                       value="{% if form.email.value %}{{ form.email.value }}{% endif %}"#}
                            {#                                       required>#}
                            {#                                {% if form.email.errors %}#}
                            {#                                    <div class="alert alert-danger alert-dismissible fade show">{{ form.email.errors }}</div>#}
                            {#                                {% endif %}#}
                            {##}
                            {#                            </div>#}

                            <div class="col-md-12 mb-3">
                                <label for="delivery" class="form-label">Способ доставки: </label>

                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="requires_delivery"
                                           id="id_requires_delivery" value="1" checked>
                                    <label class="form-check-label" for="id_requires_delivery">Нужна
                                        доставка</label>
                                </div>

                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="requires_delivery"
                                           id="id_requires_delivery" value="0">
                                    <label class="form-check-label" for="id_requires_delivery">Самовывоз</label>
                                </div>
                            </div>

                            <div class="mb-3" id="deliveryAddressField">
                                <label for="id_delivery_address" class="form-label">Адрес
                                    доставки*:</label>
                                <textarea class="form-control" id="id_delivery_address"
                                          value="


                                                  {% if form.delivery_address.value %}{{ form.delivery_address.value }}{% endif %}"
                                          name="delivery_address" rows="2"></textarea>
                                {% if form.delivery_address.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show">{{ form.delivery_address.errors }}</div>
                                {% endif %}
                            </div>


                            {# phone #}
                            {#                            Убрал телефон#}
                            {#                            <div class="col-12 mt-3">#}
                            {#                                <label for="address" class="form-label">Номер телефона</label>#}
                            {#                                <input type="text" class="form-control" id="number"#}
                            {#                                       placeholder="XXX-XXX-XX-XX" required>#}
                            {#                            </div>#}

                            {# special_offer #}

                            {#                            <div class="col-12 mt-3">#}
                            {#                                <label for="special_offer" class="form-label">Промокод</label>#}
                            {#                                <input type="text" class="form-control" id="special_offer" placeholder="SALE2024">#}
                            {#                            </div>#}

                            {# payment_on_get #}
                            {# requires_delivery #}
                            {# delivery_address #}

                        </div>

                        <h3>Карта</h3>
                        {#Уже не заглушка#}
                        <div class="col-12 mt-3">

                            <div id="map"></div>


                            <style>
                                #map {
                                    height: 520px;
                                }
                            </style>

                            <script>
                                function getAddress(lat, lng) {
                                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;

                                    fetch(url)
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.address) {
                                                console.log('Адрес: ', data.display_name);
                                                return data.display_name;
                                            } else {
                                                console.log('Адрес не найден');
                                                return 'Адрес не найден';
                                            }
                                        })
                                        .catch(error => console.error('Ошибка при получении адреса:', error));
                                }


                                const map = L.map('map').setView([55.810343, 37.498345], 13);

                                // const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                //     maxZoom: 19,
                                //     attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                // }).addTo(map);

                                let mapboxAccessToken = "pk.eyJ1IjoibGVtaXQiLCJhIjoiY2twY2ZpZDU1MWQ5cjJ2bmxrbmc2YjFpYSJ9.jXef86wp0mQLiKY0UHgiyw";
                                const tiles = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${mapboxAccessToken}`, {
                                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                                    maxZoom: 19,
                                }).addTo(map);


                                const marker = L.marker([55.810343, 37.498345]).addTo(map)
                                    .bindPopup('<b>Hello world!</b><br />МАИ - это я!').openPopup();

                                map.on('click', function (e) {
                                    let lat = e.latlng.lat;
                                    let lng = e.latlng.lng;

                                    map.eachLayer(function (layer) {
                                        if (layer instanceof L.Marker) {
                                            map.removeLayer(layer);
                                        }
                                    });

                                    let time = 10;

                                    var marker = L.marker([lat, lng]).addTo(map).bindPopup(`<b>Адрес доставки!</b><br />Доставим сюда через ${time} минут`).openPopup();

                                    console.log(`Ширина: ${lat} | Долгота: ${lng}`)
                                    getAddress(lat, lng);


                                    fetch('', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({latitude: lat, longitude: lng})
                                    }).then(response => response.json())
                                        .then(data => alert('Координаты обновлены'))
                                        .catch((e) => console.log("Ошибка отправки координат: ", e))
                                });

                            </script>

                        </div>


                        <hr class="my-4">

                        {#                    return redirect('orders:success') находится во views.py#}

                        <button class="w-100 btn btn-primary btn-lg" type="submit">Продолжить</button>
                        <hr class="my-4">
                    </form>
                </div>
            </div>


        </div>
    </section>
{% endblock %}